name: Build Arch Linux KDE Live CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build-livecd:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Arch Linux container
        run: |
          # Descargar imagen de Arch Linux
          docker pull archlinux:latest

          # Crear contenedor con privilegios necesarios
          docker run -d --name arch-builder --privileged \
            -v $PWD:/host-workspace \
            archlinux:latest sleep infinity

          # Actualizar sistema y instalar dependencias
          docker exec arch-builder pacman -Syu --noconfirm
          docker exec arch-builder pacman -S --noconfirm archiso git base-devel wget

      - name: Create archiso profile
        run: |
          docker exec arch-builder bash -c '
          # Crear directorio de trabajo
          mkdir -p /build/archiso-kde
          cd /build/archiso-kde

          # Copiar perfil base de archiso
          cp -r /usr/share/archiso/configs/releng/* .

          # Crear lista de paquetes personalizada
          cat > packages.x86_64 << "PKGEOF"
          # Base system
          base
          base-devel
          linux
          linux-firmware
          mkinitcpio
          mkinitcpio-archiso
          mkinitcpio-nfs-utils
          archiso

          # Boot
          syslinux
          efibootmgr
          grub
          os-prober

          # Filesystem tools
          dosfstools
          e2fsprogs
          ntfs-3g
          exfatprogs
          btrfs-progs
          xfsprogs
          f2fs-tools
          jfsutils

          # Network
          networkmanager
          network-manager-applet
          dhcpcd
          wpa_supplicant
          wireless_tools
          iwd
          inetutils
          dnsutils
          nftables
          iptables-nft
          reflector

          # Hardware support
          mesa
          xf86-video-intel
          xf86-video-amdgpu
          xf86-video-nouveau
          xf86-video-ati
          xf86-video-vesa
          xf86-input-libinput
          vulkan-intel
          vulkan-radeon

          # Audio
          pipewire
          pipewire-alsa
          pipewire-pulse
          pipewire-jack
          wireplumber
          pavucontrol

          # KDE Plasma (completo pero optimizado)
          plasma-desktop
          plasma-nm
          plasma-pa
          plasma-systemmonitor
          powerdevil
          sddm
          sddm-kcm
          breeze
          breeze-gtk
          kde-gtk-config
          kscreen
          kinfocenter
          systemsettings
          plasma-workspace-wallpapers

          # Aplicaciones KDE esenciales
          konsole
          dolphin
          kate
          ark
          spectacle
          okular
          gwenview
          kcalc
          kwrite

          # Navegador y multimedia
          firefox
          vlc

          # System tools
          htop
          fastfetch
          git
          vim
          nano
          wget
          curl
          rsync
          tree
          lsof
          which
          sudo

          # Fonts
          ttf-dejavu
          ttf-liberation
          noto-fonts
          noto-fonts-emoji
          terminus-font

          # Archive tools
          zip
          unzip
          p7zip
          unrar

          # Live system and installation tools
          arch-install-scripts
          gparted
          testdisk
          ddrescue
          parted
          gdisk
          dialog

          # Development tools (optional)
          python
          python-pip

          # Additional utilities
          man-db
          man-pages
          PKGEOF
          '

      - name: Create installer script
        run: |
          docker exec arch-builder bash -c '
          cd /build/archiso-kde
          mkdir -p airootfs/usr/local/bin

          cat > airootfs/usr/local/bin/arch-installer << "INSTALLEREOF"
          #!/bin/bash

          # Arch Linux Installer Script
          set -e

          # Colores
          RED="\033[0;31m"
          GREEN="\033[0;32m"
          YELLOW="\033[1;33m"
          BLUE="\033[0;34m"
          NC="\033[0m"

          print_msg() {
              echo -e "${GREEN}[INFO]${NC} $1"
          }

          print_warning() {
              echo -e "${YELLOW}[WARNING]${NC} $1"
          }

          print_error() {
              echo -e "${RED}[ERROR]${NC} $1"
          }

          print_title() {
              echo -e "${BLUE}=== $1 ===${NC}"
          }

          check_root() {
              if [ $(id -u) -ne 0 ]; then
                  print_error "Este script debe ejecutarse como root"
                  exit 1
              fi
          }

          check_internet() {
              print_msg "Verificando conexión a internet..."
              if ! ping -c 1 archlinux.org > /dev/null 2>&1; then
                  print_error "No hay conexión a internet"
                  exit 1
              fi
              print_msg "Conexión a internet OK"
          }

          show_disks() {
              print_title "Discos disponibles"
              lsblk -f
              echo ""
              fdisk -l | grep "Disk /"
          }

          partition_disk() {
              show_disks
              echo ""
              read -p "Introduce el disco (ej: /dev/sda): " DISK

              if [ ! -b "$DISK" ]; then
                  print_error "El disco $DISK no existe"
                  exit 1
              fi

              print_warning "Esto borrará todos los datos en $DISK"
              read -p "Continuar? (yes/no): " confirm
              if [ "$confirm" != "yes" ]; then
                  exit 0
              fi

              print_msg "Particionando con cfdisk..."
              cfdisk "$DISK"
          }

          format_partitions() {
              show_disks

              if [ -d /sys/firmware/efi/efivars ]; then
                  print_msg "Sistema UEFI detectado"
                  read -p "Partición EFI: " EFI_PART
                  read -p "Partición root: " ROOT_PART
                  mkfs.fat -F32 "$EFI_PART"
              else
                  print_msg "Sistema BIOS detectado"
                  read -p "Partición root: " ROOT_PART
              fi

              read -p "Partición swap (opcional): " SWAP_PART

              mkfs.ext4 "$ROOT_PART"

              if [ -n "$SWAP_PART" ]; then
                  mkswap "$SWAP_PART"
                  swapon "$SWAP_PART"
              fi

              mount "$ROOT_PART" /mnt

              if [ -d /sys/firmware/efi/efivars ]; then
                  mkdir -p /mnt/boot/efi
                  mount "$EFI_PART" /mnt/boot/efi
              fi
          }

          install_base() {
              print_msg "Instalando sistema base..."
              pacstrap /mnt base linux linux-firmware base-devel grub
              genfstab -U /mnt >> /mnt/etc/fstab
          }

          configure_system() {
              print_msg "Configurando sistema..."

              cat > /mnt/root/config.sh << "CONFEOF"
          ln -sf /usr/share/zoneinfo/Europe/Madrid /etc/localtime
          hwclock --systohc
          sed -i "s/#es_ES.UTF-8/es_ES.UTF-8/" /etc/locale.gen
          locale-gen
          echo "LANG=es_ES.UTF-8" > /etc/locale.conf
          echo "KEYMAP=es" > /etc/vconsole.conf
          read -p "Hostname: " hostname
          echo "$hostname" > /etc/hostname
          echo "Contraseña de root:"
          passwd
          read -p "Usuario: " user
          useradd -m -G wheel "$user"
          passwd "$user"
          sed -i "s/# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/" /etc/sudoers
          pacman -S --noconfirm networkmanager
          systemctl enable NetworkManager
          if [ -d /sys/firmware/efi/efivars ]; then
              pacman -S --noconfirm efibootmgr
              grub-install --target=x86_64-efi --efi-directory=/boot/efi
          else
              grub-install /dev/sda
          fi
          grub-mkconfig -o /boot/grub/grub.cfg
          CONFEOF

              arch-chroot /mnt bash /root/config.sh
              rm /mnt/root/config.sh
          }

          main() {
              print_title "Instalador de Arch Linux"
              check_root
              check_internet
              partition_disk
              format_partitions
              install_base
              configure_system
              umount -R /mnt
              print_title "Instalación completada"
          }

          case "${1:-install}" in
              "install") main ;;
              "manual") firefox "https://wiki.archlinux.org/title/Installation_guide" & ;;
              *) echo "Uso: arch-installer [install|manual]" ;;
          esac
          INSTALLEREOF

          chmod +x airootfs/usr/local/bin/arch-installer
          '

      - name: Configure desktop entries
        run: |
          docker exec arch-builder bash -c '
          cd /build/archiso-kde
          mkdir -p airootfs/etc/skel/Desktop
          mkdir -p airootfs/root/Desktop

          cat > airootfs/etc/skel/Desktop/arch-installer.desktop << "DESKTOP_EOF"
          [Desktop Entry]
          Name=Instalador de Arch Linux
          Comment=Instala Arch Linux en tu computadora
          Exec=konsole --hold -e sudo arch-installer
          Icon=system-software-install
          Terminal=false
          Type=Application
          Categories=System;
          DESKTOP_EOF

          cat > airootfs/etc/skel/Desktop/gparted.desktop << "GPARTED_EOF"
          [Desktop Entry]
          Name=GParted
          Comment=Editor de particiones
          Exec=sudo gparted
          Icon=gparted
          Terminal=false
          Type=Application
          Categories=System;
          GPARTED_EOF

          chmod +x airootfs/etc/skel/Desktop/*.desktop
          cp airootfs/etc/skel/Desktop/*.desktop airootfs/root/Desktop/
          chmod +x airootfs/root/Desktop/*.desktop
          '

      - name: Create pacman.conf
        run: |
          docker exec arch-builder bash -c '
          cd /build/archiso-kde

          cat > pacman.conf << "PACMANEOF"
          [options]
          HoldPkg = pacman glibc
          Architecture = x86_64
          Color
          CheckSpace
          ParallelDownloads = 10
          SigLevel = Required DatabaseOptional
          LocalFileSigLevel = Optional

          [core]
          Include = /etc/pacman.d/mirrorlist

          [extra]
          Include = /etc/pacman.d/mirrorlist

          [multilib]
          Include = /etc/pacman.d/mirrorlist
          PACMANEOF
          '

      - name: Configure system customization
        run: |
          docker exec arch-builder bash -c '
          cd /build/archiso-kde
          mkdir -p airootfs/etc/skel/.config
          mkdir -p airootfs/etc/systemd/system
          mkdir -p airootfs/etc/sddm.conf.d

          cat > airootfs/root/customize_airootfs.sh << "CUSTOMEOF"
          #!/usr/bin/env bash
          set -e -u

          echo "Iniciando customización..."

          # Locale
          sed -i "s/#en_US.UTF-8/en_US.UTF-8/" /etc/locale.gen
          sed -i "s/#es_ES.UTF-8/es_ES.UTF-8/" /etc/locale.gen
          locale-gen
          echo "LANG=en_US.UTF-8" > /etc/locale.conf
          echo "KEYMAP=es" > /etc/vconsole.conf

          # Timezone
          ln -sf /usr/share/zoneinfo/UTC /etc/localtime

          # Usuario
          useradd -m -G wheel,audio,video,storage,network -s /bin/bash liveuser
          passwd -d liveuser
          passwd -d root
          echo "%wheel ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers

          # Servicios
          systemctl enable NetworkManager.service
          systemctl enable sddm.service

          # SDDM autologin
          cat > /etc/sddm.conf.d/autologin.conf << EOF
          [Autologin]
          User=liveuser
          Session=plasma
          [Theme]
          Current=breeze
          EOF

          # Hostname
          echo "archiso-kde" > /etc/hostname

          # Bashrc
          cat >> /home/liveuser/.bashrc << EOF
          alias ll="ls -la"
          echo "=== Arch Linux KDE Live ==="
          echo "Usuario: liveuser (sin contraseña)"
          EOF

          chown -R liveuser:liveuser /home/liveuser
          pacman -Scc --noconfirm
          CUSTOMEOF

          chmod +x airootfs/root/customize_airootfs.sh
          '

      - name: Configure boot
        run: |
          docker exec arch-builder bash -c '
          cd /build/archiso-kde

          # GRUB
          mkdir -p grub
          cat > grub/grub.cfg << "GRUBEOF"
          set default="0"
          set timeout=5

          menuentry "Arch Linux KDE Live" {
              linux /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL% quiet
              initrd /%INSTALL_DIR%/boot/x86_64/initramfs-linux.img
          }
          GRUBEOF

          # Syslinux
          cat > syslinux/archiso_sys-linux.cfg << "SYSEOF"
          LABEL arch64
          MENU LABEL Arch Linux KDE Live
          LINUX /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux
          INITRD /%INSTALL_DIR%/boot/x86_64/initramfs-linux.img
          APPEND archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL% quiet
          SYSEOF

          # SystemD-boot
          mkdir -p efiboot/loader/entries
          cat > efiboot/loader/loader.conf << "LOADEREOF"
          default archiso-x86_64-linux.conf
          timeout 3
          LOADEREOF

          cat > efiboot/loader/entries/archiso-x86_64-linux.conf << "ENTRYEOF"
          title Arch Linux KDE Live
          linux /%INSTALL_DIR%/boot/x86_64/vmlinuz-linux
          initrd /%INSTALL_DIR%/boot/x86_64/initramfs-linux.img
          options archisobasedir=%INSTALL_DIR% archisolabel=%ARCHISO_LABEL% quiet
          ENTRYEOF

          # Profile
          cat > profiledef.sh << "PROFILEEOF"
          #!/usr/bin/env bash
          iso_name="archlinux-kde"
          iso_label="ARCH_KDE_$(date +%Y%m)"
          iso_publisher="Arch Linux KDE Live"
          iso_application="Arch Linux KDE Live CD"
          iso_version="$(date +%Y.%m.%d)"
          install_dir="arch"
          buildmodes=("iso")
          bootmodes=("bios.syslinux.mbr" "bios.syslinux.eltorito" "uefi-x64.systemd-boot.esp" "uefi-x64.systemd-boot.eltorito")
          arch="x86_64"
          pacman_conf="pacman.conf"
          airootfs_image_type="squashfs"
          airootfs_image_tool_options=("-comp" "xz" "-b" "1M")
          file_permissions=(
            ["/root"]="0:0:750"
            ["/root/customize_airootfs.sh"]="0:0:755"
            ["/usr/local/bin/arch-installer"]="0:0:755"
          )
          PROFILEEOF
          '

      - name: Build ISO
        run: |
          docker exec arch-builder bash -c '
          cd /build/archiso-kde
          echo "=== Archivos del proyecto ==="
          ls -la
          echo "=== Construyendo ISO ==="
          mkarchiso -v -w work -o out .
          ls -la out/
          '
          mkdir -p iso-output
          docker cp arch-builder:/build/archiso-kde/out/. ./iso-output/
          ls -lh ./iso-output/

      - name: Cleanup
        if: always()
        run: |
          docker stop arch-builder || true
          docker rm arch-builder || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-kde-livecd
          path: iso-output/*.iso
          retention-days: 30

      - name: Create Release
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Arch Linux KDE Live CD v${{ github.run_number }}
          body: |
            # 🐧 Arch Linux Live CD con KDE Plasma

            ## ✨ Características:
            - **Entorno**: KDE Plasma completo
            - **Usuario**: `liveuser` (sin contraseña, autologin)
            - **Red**: NetworkManager habilitado
            - **Instalador**: Script guiado incluido

            ## 📦 Aplicaciones:
            - Firefox, Konsole, Dolphin, Kate
            - GParted, Instalador de Arch Linux
            - Spectacle, Okular, Gwenview, VLC

            ## 💻 Requisitos:
            - **RAM**: 2GB mín, 4GB recomendado
            - **Arch**: x86_64
            - **Boot**: UEFI/BIOS compatible

            ## 🚀 Uso:
            1. Descarga la ISO
            2. Graba en USB con Rufus/Etcher
            3. Arranca desde USB
            4. Usa "Instalador de Arch Linux" del escritorio

            **Tamaño**: ~2.5GB
          files: iso-output/*.iso
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
